#!/usr/bin/env ruby
#
# These environment variables are available:
# KAMAL_RECORDED_AT
# KAMAL_PERFORMER
# KAMAL_VERSION
# KAMAL_HOSTS
# KAMAL_COMMAND
# KAMAL_SUBCOMMAND
# KAMAL_ROLE (if set)
# KAMAL_DESTINATION (if set)

#!/bin/sh

set -e  # Exit immediately on error
set -o pipefail  # Fail if any piped command fails

echo "üöÄ Running pre-deploy hook for Kamal (Locally)"

# Ensure required env vars exist
if [ -z "$TURSO_DB_URL" ]; then
  echo "‚ùå ERROR: TURSO_DB_URL is not set!"
  exit 1
fi

if [ -z "$TURSO_DB_AUTH_TOKEN" ]; then
  echo "‚ùå ERROR: TURSO_DB_AUTH_TOKEN is not set!"
  exit 1
fi

if [ -z "$TRIPLIT_SERVICE_TOKEN" ]; then
  echo "‚ùå ERROR: TRIPLIT_SERVICE_TOKEN is not set!"
  exit 1
fi

if [ -z "$PUBLIC_TRIPLIT_URL" ]; then
  echo "‚ùå ERROR: PUBLIC_TRIPLIT_URL is not set!"
  exit 1
fi


# Run Drizzle migrations locally
echo "üîÑ Running Drizzle migrations locally..."
TURSO_DB_URL="$TURSO_DB_URL" TURSO_DB_AUTH_TOKEN="$TURSO_DB_AUTH_TOKEN" npm run migrate

# Run Triplit schema push locally
echo "üîÑ Pushing Triplit schema locally..."
npx triplit schema push --token "$TRIPLIT_SERVICE_TOKEN" --remote "$PUBLIC_TRIPLIT_URL"

echo "‚úÖ Pre-deploy steps completed successfully."
